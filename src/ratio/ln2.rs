use crate::{BigInt, Ratio};

/// It returns an approximate value of ln(2).
/// It gets more and more accurate as `k` gets bigger.
/// For now, `k` should be less than 255.
pub fn ln2_iter(k: usize) -> Ratio {
    let data = spigot_cache();
    let mut result = Ratio::from_denom_and_numer_i32(960, 661);
    let mut coeff = BigInt::from_i64(32);

    for i in 0..k {
        let (denom, numer) = data[i];
        let curr = Ratio::from_denom_and_numer_raw(BigInt::from_i64(denom), BigInt::from_i64(numer));
        result.add_rat_mut(&curr.div_bi(&coeff));
        coeff.mul_i32_mut(32);
    }

    result
}

fn spigot_cache() -> Vec<(i64, i64)> {
    vec![
        //(960, 661),
        (10080, 1459),
        (15015, 1238),
        (1860480, 107447),
        (17001600, 755927),
        (22800960, 824281),
        (77911680, 2373229),
        (105281280, 2770891),
        (390962880, 9058367),
        (508502400, 10522639),
        (69575220, 1300757),
        (436920960, 7449443),
        (7929492480, 124258621),
        (1936482240, 28074271),
        (1380751200, 18623663),
        (11539207680, 145509743),
        (10496485440, 124271447),
        (878985360, 9807227),
        (869107785, 9168934),
        (1505750400, 15064997),
        (30899406720, 293966087),
        (58747930560, 532745183),
        (12278091840, 106362983),
        (30492483840, 252845071),
        (225150024000, 1790326381),
        (22899502080, 174911003),
        (6934005540, 50954417),
        (100071726720, 708501799),
        (159419969280, 1088891567),
        (94656004800, 624514651),
        (167646457440, 1069659109),
        (131261445120, 810804361),
        (306778570560, 1836426407),
        (133804114080, 776966747),
        (6455750175, 36396068),
        (59553901440, 326257639),
        (1641650075520, 8746235941),
        (313088086080, 1623401041),
        (178499493120, 901417823),
        (1217112019200, 5990247353),
        (919170813120, 4411800287),
        (259522623360, 1215533393),
        (219189707580, 1002392431),
        (328205243520, 1466328023),
        (1470447014400, 6421463327),
        (2464293622080, 10524386693),
        (457771073760, 1912861343),
        (1018087687680, 4164407341),
        (6777734927040, 27150579301),
        (78170313000, 306795211),
        (43187437755, 166132508),
        (285762946560, 1077866063),
        (3355181976960, 12413701607),
        (1843242488640, 6691946221),
        (3032592763200, 10807402789),
        (2213780808960, 7746867031),
        (4840316898240, 16637620847),
        (3962472433920, 13382780149),
        (359883186180, 1194637937),
        (1566627004800, 5112843713),
        (20430522658560, 65572508461),
        (3695467849920, 11667461011),
        (2002664795040, 6221500583),
        (13006909470720, 39769728563),
        (9374768020800, 28218819527),
        (1265399852640, 3750686239),
        (511813336005, 1494172894),
        (1470426222720, 4228997329),
        (12659625982080, 35876962967),
        (20414478033600, 57019923803),
        (3653968855680, 10060904303),
        (7840376651520, 21285342811),
        (50420440150080, 134991735421),
        (4499163745920, 11881522973),
        (1203309376500, 3135003797),
        (15433833018240, 39676519009),
        (21975957104640, 55754898047),
        (11724192492480, 29360814991),
        (18749024988960, 46353908269),
        (13314976012800, 32504334901),
        (28345269625920, 68335073687),
        (5652723919920, 13460161651),
        (500640852915, 1177643438),
        (2126756311680, 4942700687),
        (108337719081600, 248798532181),
        (19148983613760, 43460670181),
        (10146976176960, 22762999943),
        (64479138282240, 142992241373),
        (45496322988480, 99753201167),
        (12030619507200, 26082634163),
        (9537848780460, 20449429171),
        (13434632127360, 28488987893),
        (56736632789760, 119011057007),
        (89800621485120, 186348764513),
        (15783551757600, 32405979863),
        (33271219215360, 67594467481),
        (210288891933120, 422793730741),
        (9225050173920, 18356821429),
        (1213429140495, 2390041928),
        (30629362512000, 59722268657),
        (85861817032320, 165748512887),
        (45107513056320, 86216976961),
        (71057278494720, 134489719549),
        (49725532496640, 93204743971),
        (104344422033600, 193707536927),
        (82071395725440, 150913356859),
        (7169306557140, 13059023717),
        (30047795648640, 54222840383),
        (377643287984640, 675188723101),
        (65892244017600, 116731604551),
        (34476827558880, 60524123903),
        (216383435573760, 376450553783),
        (150835600196160, 260079137207),
        (2463336296820, 4209955403),
        (7721052564225, 13080255304),
        (2687951638080, 4514194733),
        (179599497517440, 299030657447),
        (281151458696640, 464124796823),
        (48885046499520, 80017656023),
        (101962056019200, 165498757351),
        (637779529316160, 1026605461261),
        (55388647829760, 88422049343),
        (14425980587460, 22841333777),
        (180287943749760, 283144487419),
        (250266875040000, 389886898127),
        (130236120020160, 201274448131),
        (203255883840480, 311637620629),
        (140940820500480, 214397790241),
        (293101705001280, 442390082567),
        (114253590765600, 171114487457),
        (4947087275655, 7352284958),
        (41115274865280, 60639742309),
        (1024832026807680, 1500076457221),
        (177343870501440, 257637000121),
        (92040563260800, 132717160463),
        (573064804865280, 820221913793),
        (396339717723840, 563117139647),
        (102765264551040, 144945377333),
        (79915616813340, 111902443711),
        (110453987011200, 153554266163),
        (457868707845120, 631998996287),
        (711577074788160, 975246388733),
        (122843482201440, 167179580783),
        (254423220503040, 343833348421),
        (1580437476139200, 2121044782981),
        (34080154027920, 45423037607),
        (8816670083235, 11670833498),
        (109458080138880, 143909028331),
        (603821910007680, 788518725767),
        (312207150024000, 404975404501),
        (484173534786240, 623862635509),
        (333642207064320, 427061329711),
        (689584819008960, 876874102607),
        (534358121256960, 675057804769),
        (45998385128100, 57733594097),
        (190021673412480, 236965343453),
        (2354481353790720, 2917364070541),
        (405103809305280, 498761752891),
        (209060134002720, 255768477623),
        (1294407552076800, 1573668049403),
        (890313771251520, 1075644040487),
        (114797445216480, 137834517409),
        (44397596072445, 52978808164),
        (122079296626560, 144783203599),
        (1006849833052800, 1186835625527),
        (1556712841279680, 1823896388243),
        (267381046383360, 311389482143),
        (551005250906880, 637861536691),
        (3405844413042240, 3919298511901),
        (292337805513600, 334423434113),
        (75264628278420, 85594520357),
        (929958322001280, 1051421399029),
        (1276496990415360, 1434848987807),
        (656953272507840, 734190182071),
        (1014141056292000, 1126872028189),
        (695678368028160, 768601378381),
        (1431427858136640, 1572507309047),
        (138039088782840, 150789048803),
        (23661557578395, 25702144628),
        (48662872876800, 52564888111),
        (4803149179973760, 5159522859061),
        (822934643469120, 879118918861),
        (422921752904640, 449318523383),
        (2607779221528320, 2755435168613),
        (1786383458059200, 1877292991727),
        (458823972314880, 479572466903),
        (353488857326220, 367491484051),
        (484083706055040, 500573586833),
        (1988496148020480, 2045316417167),
        (3062663352091200, 3133542123353),
        (524047740965280, 533359168103),
        (1075880202270720, 1089274778161),
        (6625506449465280, 6673122424021),
        (283304331377760, 283864734199),
        (36337133625975, 36221691218),
        (894730008923520, 887322284267),
        (2447564098343040, 2414938996247),
        (1255224001711680, 1232217276841),
        (1930963372517760, 1886015302669),
        (1320046600032000, 1282852112251),
        (2706893934064320, 2617493733887),
        (2081280039108480, 2002547515879),
        (177784485939060, 170213805077),
        (728862381256320, 694393536923),
        (8963261781196800, 8497593078781),
        (1530742904832960, 1444149714031),
        (784166551486560, 736221825743),
        (4819974531939840, 4503453959423),
        (3291457701026880, 3060553465367),
        (210694493629200, 194977990397),
        (161826600340665, 149043463474),
        (220940406234240, 202524983267),
        (3619371257228160, 3302073563207),
        (5557946359542720, 5046935402063),
        (948212038267200, 857014526663),
        (1941022958434560, 1746192688831),
        (11918741995648320, 10672841255341),
        (1016368936957440, 905937901283),
        (259984670689380, 230675459537),
        (3191831049052800, 2819092085839),
        (4353559753470720, 3827706383087),
        (2226567008675520, 1948783344811),
        (3415891474823520, 2976284202949),
        (2328874132515840, 2020075867321),
        (4762837800072000, 4112893729127),
        (1826180880777120, 1569980102567),
        (77792300721135, 66583126448),
        (636192256629120, 542127743779),
        (15607001670099840, 13241183945701),
        (2658560386036800, 2245723514401),
        (1358481235668480, 1142546992703),
        (8329159312431360, 6974939589833),
        (5673691272634560, 4730771253407),
        (1449176767758720, 1203157886873),
        (1110346394639100, 917915558191),
        (1512284943818880, 1244883653903),
        (6178611718755840, 5064595575647),
        (9465436710354240, 7726112512373),
        (1611051537009120, 1309495525823),
        (3290192544038400, 2663163044701),
        (20156569634631360, 16247348701861),
        (53591010488730, 43018451899),
        (109418633528715, 87469879088),
        (167538643618080, 133381020467),
        (7296247637078400, 5784925100327),
        (3723309433239360, 2940043201981),
        (5699594389769280, 4482312713029),
        (3877399439719680, 3036963139591),
        (7912668475039680, 6172623966767),
        (6054824062560000, 4704389722189),
        (514757545630020, 398351432657),
        (2100441422540160, 1618985884793),
        (25710195468122880, 19738473635821),
        (4370525452520640, 3342137855971),
        (2228688741770400, 1697576712263),
        (13636814438522880, 10346391707843),
    ]
}

#[cfg(test)]
mod tests {
    use super::ln2_iter;

    #[test]
    fn ln2_test() {
        assert_eq!(
            ln2_iter(2).to_approx_string(7),
            "0.69314"
        );
        assert_eq!(
            ln2_iter(3).to_approx_string(9),
            "0.6931471"
        );
        assert_eq!(
            ln2_iter(4).to_approx_string(9),
            "0.6931471"
        );
        assert_eq!(
            ln2_iter(5).to_approx_string(12),
            "0.6931471805"
        );
        assert_eq!(
            ln2_iter(6).to_approx_string(14),
            "0.693147180559"
        );
    }

}